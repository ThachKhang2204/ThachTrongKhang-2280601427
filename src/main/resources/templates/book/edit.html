<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial
scale=1.0">
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
    <title>Edit Book</title>
</head>

<body>
    <th:block th:replace="~{layout::header}"></th:block>
    <div class="container">
        <h1>Edit Book</h1>
        <form th:action="@{/books/edit}" th:object="${book}" method="post">
            <input type="hidden" th:field="*{id}">
            <div class="col-6 mb-3">
                <label class="form-label" for="title">Title:</label>
                <input class="form-control" type="text" th:field="*{title}" id="title" required autofocus>
                <span class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></span>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label" for="author">Author:</label>
                <input class="form-control" type="text" th:field="*{author}" id="author">
                <span class="text-danger" th:if="${#fields.hasErrors('author')}" th:errors="*{author}"></span>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label" for="price">Price:</label>
                <input class="form-control" type="text" th:field="*{price}" id="price">
                <span class="text-danger" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></span>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label" for="category">Category:</label><span class="text-danger">*</span>
                <select class="form-control" id="category" name="category.id">
                    <option value="">-- Select Category --</option>
                    <option th:each="category : ${categories}" th:value="${category.getId()}"
                        th:text="${category.getName()}" th:selected="${category.getId() == book.category.getId()}"></option>
                </select>
            </div>
            
            <!-- Image Upload Section -->
            <div class="col-6 mb-3">
                <label class="form-label">Hình Ảnh Sách:</label>
                <div class="mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="imageOption" id="imageUrlOption" value="url" checked onclick="toggleImageInput()">
                        <label class="form-check-label" for="imageUrlOption">
                            Nhập URL hình ảnh
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="imageOption" id="imageUploadOption" value="upload" onclick="toggleImageInput()">
                        <label class="form-check-label" for="imageUploadOption">
                            Tải lên từ máy
                        </label>
                    </div>
                </div>
                
                <!-- Hidden field that will be submitted with form -->
                <input type="hidden" th:field="*{imageUrl}" id="hiddenImageUrl">
                
                <div id="urlInput" style="display: block;">
                    <input class="form-control" type="url" id="imageUrlField" 
                        th:value="${book.imageUrl}"
                        placeholder="https://example.com/image.jpg">
                    <small class="text-muted">Ví dụ: https://example.com/book-cover.jpg</small>
                </div>
                
                <div id="fileInput" style="display: none;">
                    <input class="form-control" type="file" id="imageFile" accept="image/*" onchange="handleFileSelect(event)">
                    <small class="text-muted">Chọn file ảnh từ máy tính (JPG, PNG, GIF)</small>
                </div>
                
                <div id="imagePreview" class="mt-3">
                    <label class="form-label">Xem trước:</label>
                    <div style="max-width: 200px;">
                        <img id="previewImg" th:src="${book.imageUrl != null ? book.imageUrl : 'https://via.placeholder.com/200x300?text=No+Image'}" 
                            alt="Preview" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                </div>
            </div>
            
            <input type="submit" value="Save">
        </form>
        <br>
        <a th:href="@{/books}">Back to List</a>
    </div>
    <th:block th:replace="~{layout::footer}"></th:block>
    
    <script>
        // Initialize hidden field with current value on load
        document.addEventListener('DOMContentLoaded', function() {
            const imageUrlField = document.getElementById('imageUrlField');
            const hiddenImageUrl = document.getElementById('hiddenImageUrl');
            if (imageUrlField.value) {
                hiddenImageUrl.value = imageUrlField.value;
            }
        });
        
        function toggleImageInput() {
            const urlOption = document.getElementById('imageUrlOption');
            const urlInput = document.getElementById('urlInput');
            const fileInput = document.getElementById('fileInput');
            const imageFile = document.getElementById('imageFile');
            
            if (urlOption.checked) {
                urlInput.style.display = 'block';
                fileInput.style.display = 'none';
                imageFile.value = '';
            } else {
                urlInput.style.display = 'none';
                fileInput.style.display = 'block';
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const hiddenImageUrl = document.getElementById('hiddenImageUrl');
            const previewImg = document.getElementById('previewImg');
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Convert image to base64 and store in hidden field
                    const base64String = e.target.result;
                    hiddenImageUrl.value = base64String;
                    
                    // Show preview
                    previewImg.src = base64String;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Listen for URL input changes to update hidden field and show preview
        document.getElementById('imageUrlField').addEventListener('input', function(e) {
            const url = e.target.value;
            const hiddenImageUrl = document.getElementById('hiddenImageUrl');
            const previewImg = document.getElementById('previewImg');
            
            // Update hidden field
            hiddenImageUrl.value = url;
            
            if (url) {
                previewImg.src = url;
                previewImg.onerror = function() {
                    this.src = 'https://via.placeholder.com/200x300?text=Invalid+URL';
                };
            }
        });
    </script>
</body>

</html>