<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Danh S√°ch S√°ch - BookHaven</title>
  <th:block th:replace="~{layout::link-css}"></th:block>
  <th:block th:replace="~{layout::custom-css}"></th:block>
  <style>
    .modal-backdrop {
      z-index: 1040;
    }
    .modal {
      z-index: 1050;
    }
    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    .page-header h2 {
      margin: 0;
      font-weight: 700;
    }
    .search-box {
      background: white;
      padding: 0.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Book Card Styles */
    .book-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 2rem;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .book-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    .book-card-img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .book-card-body {
      padding: 1.5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .book-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .book-author {
      color: #718096;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .book-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: #48bb78;
      margin-bottom: 1rem;
    }
    .book-category {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .book-actions {
      margin-top: auto;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .badge {
      padding: 0.5rem 0.75rem;
      font-weight: 500;
    }
    
    /* Pagination Styles */
    .pagination {
      margin-top: 2rem;
    }
    .pagination .page-link {
      color: #667eea;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0 0.25rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .pagination .page-link:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .pagination .page-item.active .page-link {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }
  </style>
</head>

<body>
  <th:block th:replace="~{layout::header}"></th:block>
  <div class="container">

    <div class="page-header">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h2>üìö Danh S√°ch S√°ch</h2>
        </div>
        <div class="col-md-6">
          <div class="search-box d-flex">
            <input class="form-control me-2 border-0" type="search" placeholder="T√¨m ki·∫øm s√°ch..." aria-label="Search" id="searchInput">
            <button class="btn btn-primary" type="button" onclick="searchBooks()">T√¨m Ki·∫øm</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 text-end mb-3">
        <button class="btn btn-primary" sec:authorize="hasAuthority('ADMIN')" onclick="showAddModal()">
          + Th√™m S√°ch M·ªõi
        </button>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div id="loadingSpinner" class="text-center my-5" style="display: none;">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
      </div>
    </div>
    
    <!-- Books Grid -->
    <div class="row" id="booksGrid">
      <!-- Books will be loaded here as cards -->
    </div>
    
    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center" id="pagination">
        <!-- Pagination will be generated here -->
      </ul>
    </nav>
  </div>

  <!-- Add/Edit Book Modal -->
  <div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bookModalLabel">Add Book</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="bookForm">
            <input type="hidden" id="bookId">
            <div class="mb-3">
              <label for="bookTitle" class="form-label">Ti√™u ƒê·ªÅ</label>
              <input type="text" class="form-control" id="bookTitle" required maxlength="50">
              <div class="invalid-feedback">Ti√™u ƒë·ªÅ l√† b·∫Øt bu·ªôc (1-50 k√Ω t·ª±)</div>
            </div>
            <div class="mb-3">
              <label for="bookAuthor" class="form-label">T√°c Gi·∫£</label>
              <input type="text" class="form-control" id="bookAuthor" required maxlength="50">
              <div class="invalid-feedback">T√°c gi·∫£ l√† b·∫Øt bu·ªôc (1-50 k√Ω t·ª±)</div>
            </div>
            <div class="mb-3">
              <label for="bookPrice" class="form-label">Gi√° (VNƒê)</label>
              <input type="number" step="0.01" class="form-control" id="bookPrice" required min="0.01">
              <div class="invalid-feedback">Gi√° ph·∫£i l·ªõn h∆°n 0</div>
            </div>
            <div class="mb-3">
              <label for="bookImageUrl" class="form-label">H√¨nh ·∫¢nh S√°ch</label>
              <div class="mb-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="imageOptionModal" id="imageUrlOptionModal" value="url" checked>
                  <label class="form-check-label" for="imageUrlOptionModal">
                    Nh·∫≠p URL
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="imageOptionModal" id="imageUploadOptionModal" value="upload">
                  <label class="form-check-label" for="imageUploadOptionModal">
                    Upload t·ª´ m√°y
                  </label>
                </div>
              </div>
              
              <div id="urlInputModal">
                <input type="url" class="form-control" id="bookImageUrl" placeholder="https://example.com/image.jpg">
                <div class="form-text">Nh·∫≠p URL h√¨nh ·∫£nh s√°ch</div>
              </div>
              
              <div id="fileInputModal" style="display: none;">
                <input type="file" class="form-control" id="bookImageFile" accept="image/*">
                <div class="form-text">Ch·ªçn file ·∫£nh (JPG, PNG, GIF)</div>
              </div>
              
              <div id="imagePreviewModal" class="mt-2" style="display: none;">
                <img id="previewImgModal" src="" alt="Preview" style="max-width: 200px; border-radius: 8px; border: 1px solid #ddd;">
              </div>
            </div>
            <div class="mb-3">
              <label for="bookCategory" class="form-label">Th·ªÉ Lo·∫°i</label>
              <select class="form-select" id="bookCategory" required>
                <option value="">Ch·ªçn th·ªÉ lo·∫°i...</option>
              </select>
              <div class="invalid-feedback">Vui l√≤ng ch·ªçn th·ªÉ lo·∫°i</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" onclick="saveBook()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <th:block th:replace="~{layout::footer}"></th:block>
  
  <!-- Load Bootstrap Bundle JS (includes Popper) -->
  <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/js/jquery-3.7.0.min.js}"></script>

  <script th:inline="javascript">
    const API_BASE_URL = '/api/v1';
    let currentPage = 0;
    let currentSortBy = 'id';
    let categories = [];
    let bookModal;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      bookModal = new bootstrap.Modal(document.getElementById('bookModal'));
      loadCategories();
      loadBooks(0, 'id');
      
      // Setup image upload handlers
      setupImageUploadHandlers();
    });
    
    // Setup image upload event handlers
    function setupImageUploadHandlers() {
      // Toggle between URL and file input
      document.querySelectorAll('input[name="imageOptionModal"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const urlInput = document.getElementById('urlInputModal');
          const fileInput = document.getElementById('fileInputModal');
          const imageUrl = document.getElementById('bookImageUrl');
          const imageFile = document.getElementById('bookImageFile');
          const preview = document.getElementById('imagePreviewModal');
          
          if (this.value === 'url') {
            urlInput.style.display = 'block';
            fileInput.style.display = 'none';
            imageFile.value = '';
          } else {
            urlInput.style.display = 'none';
            fileInput.style.display = 'block';
            imageUrl.value = '';
          }
          preview.style.display = 'none';
        });
      });
      
      // Handle file selection
      document.getElementById('bookImageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const imageUrl = document.getElementById('bookImageUrl');
        const preview = document.getElementById('imagePreviewModal');
        const previewImg = document.getElementById('previewImgModal');
        
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(event) {
            const base64 = event.target.result;
            imageUrl.value = base64; // Store base64 in URL field
            previewImg.src = base64;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Handle URL input for preview
      document.getElementById('bookImageUrl').addEventListener('input', function(e) {
        const url = e.target.value;
        const preview = document.getElementById('imagePreviewModal');
        const previewImg = document.getElementById('previewImgModal');
        
        if (url && (url.startsWith('http') || url.startsWith('data:'))) {
          previewImg.src = url;
          previewImg.onload = () => preview.style.display = 'block';
          previewImg.onerror = () => preview.style.display = 'none';
        } else {
          preview.style.display = 'none';
        }
      });
    }

    // Load categories for dropdown
    async function loadCategories() {
      try {
        // Assuming you have a category API endpoint
        const response = await fetch(`${API_BASE_URL}/categories`);
        categories = await response.json();
        
        const select = document.getElementById('bookCategory');
        select.innerHTML = '<option value="">Select category...</option>';
        categories.forEach(cat => {
          select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
        });
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    // Load books from API
    async function loadBooks(pageNo = 0, sortBy = 'id') {
      currentPage = pageNo;
      currentSortBy = sortBy;
      
      showLoading(true);
      hideError();

      try {
        const response = await fetch(`${API_BASE_URL}/books?pageNo=${pageNo}&pageSize=12&sortBy=${sortBy}`);
        if (!response.ok) throw new Error('Failed to load books');
        
        const data = await response.json();
        displayBooks(data.content);
        displayPagination(data.totalPages, pageNo);
      } catch (error) {
        showError('Error loading books: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Display books as cards
    function displayBooks(books) {
      const grid = document.getElementById('booksGrid');
      const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
      const isAdmin = /*[[${#authorization.expression('hasAuthority(''ADMIN'')')}]]*/ false;

      if (books.length === 0) {
        grid.innerHTML = '<div class="col-12 text-center"><p class="text-muted">Kh√¥ng t√¨m th·∫•y s√°ch</p></div>';
        return;
      }

      let html = '';
      books.forEach(book => {
        const imageUrl = book.imageUrl || 'https://via.placeholder.com/300x400?text=No+Image';
        html += '<div class="col-md-4 col-lg-3">';
        html += '  <div class="book-card">';
        html += '    <img src="' + imageUrl + '" alt="' + book.title + '" class="book-card-img" onerror="this.src=\'https://via.placeholder.com/300x400?text=No+Image\'">';
        html += '    <div class="book-card-body">';
        html += '      <h5 class="book-title">' + book.title + '</h5>';
        html += '      <p class="book-author">T√°c gi·∫£: ' + book.author + '</p>';
        html += '      <div class="book-category">' + (book.category || 'N/A') + '</div>';
        html += '      <div class="book-price">' + book.price.toLocaleString('vi-VN') + 'ƒë</div>';
        
        if (isAuthenticated) {
          html += '      <div class="book-actions">';
          if (isAdmin) {
            html += '        <button class="btn btn-sm btn-primary" onclick="showEditModal(' + book.id + ')">S·ª≠a</button>';
            html += '        <button class="btn btn-sm btn-danger" onclick="deleteBook(' + book.id + ')">X√≥a</button>';
          } else {
            const safeTitle = book.title.replace(/'/g, "\\'");
            html += '        <button class="btn btn-sm btn-success flex-grow-1" onclick="addToCart(' + book.id + ', \'' + safeTitle + '\', ' + book.price + ')">Th√™m v√†o gi·ªè</button>';
          }
          html += '      </div>';
        }
        
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
      });
      grid.innerHTML = html;
    }
    
    // Display pagination
    function displayPagination(totalPages, currentPage) {
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // Previous button
      if (currentPage > 0) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadBooks(' + (currentPage - 1) + ', \'' + currentSortBy + '\'); return false;">Tr∆∞·ªõc</a></li>';
      }
      
      // Page numbers
      const startPage = Math.max(0, currentPage - 2);
      const endPage = Math.min(totalPages - 1, currentPage + 2);
      
      if (startPage > 0) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadBooks(0, \'' + currentSortBy + '\'); return false;">1</a></li>';
        if (startPage > 1) {
          html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const active = i === currentPage ? 'active' : '';
        html += '<li class="page-item ' + active + '"><a class="page-link" href="#" onclick="loadBooks(' + i + ', \'' + currentSortBy + '\'); return false;">' + (i + 1) + '</a></li>';
      }
      
      if (endPage < totalPages - 1) {
        if (endPage < totalPages - 2) {
          html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadBooks(' + (totalPages - 1) + ', \'' + currentSortBy + '\'); return false;">' + totalPages + '</a></li>';
      }
      
      // Next button
      if (currentPage < totalPages - 1) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadBooks(' + (currentPage + 1) + ', \'' + currentSortBy + '\'); return false;">Sau</a></li>';
      }
      
      pagination.innerHTML = html;
    }

    // Search books
    async function searchBooks() {
      const keyword = document.getElementById('searchInput').value;
      if (!keyword.trim()) {
        loadBooks(0, currentSortBy);
        return;
      }

      showLoading(true);
      hideError();

      try {
        const response = await fetch(`${API_BASE_URL}/books/search?keyword=${encodeURIComponent(keyword)}`);
        if (!response.ok) throw new Error('Failed to search books');
        
        const books = await response.json();
        displayBooks(books);
        // Hide pagination for search results
        document.getElementById('pagination').innerHTML = '';
      } catch (error) {
        showError('Error searching books: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Show add modal
    function showAddModal() {
      document.getElementById('bookModalLabel').textContent = 'Th√™m S√°ch';
      document.getElementById('bookForm').reset();
      document.getElementById('bookId').value = '';
      document.getElementById('bookImageUrl').value = '';
      document.getElementById('bookImageFile').value = '';
      document.getElementById('imageUrlOptionModal').checked = true;
      document.getElementById('urlInputModal').style.display = 'block';
      document.getElementById('fileInputModal').style.display = 'none';
      document.getElementById('imagePreviewModal').style.display = 'none';
      document.getElementById('bookForm').classList.remove('was-validated');
      bookModal.show();
    }

    // Show edit modal
    async function showEditModal(id) {
      try {
        const response = await fetch(`${API_BASE_URL}/books/id/${id}`);
        if (!response.ok) throw new Error('Failed to load book');
        
        const book = await response.json();
        
        document.getElementById('bookModalLabel').textContent = 'S·ª≠a S√°ch';
        document.getElementById('bookId').value = book.id;
        document.getElementById('bookTitle').value = book.title;
        document.getElementById('bookAuthor').value = book.author;
        document.getElementById('bookPrice').value = book.price;
        document.getElementById('bookImageUrl').value = book.imageUrl || '';
        
        // Find category id by name
        const category = categories.find(c => c.name === book.category);
        if (category) {
          document.getElementById('bookCategory').value = category.id;
        }
        
        document.getElementById('bookForm').classList.remove('was-validated');
        bookModal.show();
      } catch (error) {
        showError('Error loading book: ' + error.message);
      }
    }

    // Save book (create or update)
    async function saveBook() {
      const form = document.getElementById('bookForm');
      
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      const bookId = document.getElementById('bookId').value;
      const bookData = {
        title: document.getElementById('bookTitle').value,
        author: document.getElementById('bookAuthor').value,
        price: parseFloat(document.getElementById('bookPrice').value),
        imageUrl: document.getElementById('bookImageUrl').value || null,
        categoryId: parseInt(document.getElementById('bookCategory').value)
      };

      try {
        const url = bookId ? `${API_BASE_URL}/books/${bookId}` : `${API_BASE_URL}/books`;
        const method = bookId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bookData)
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(error || 'Failed to save book');
        }

        bookModal.hide();
        loadBooks(currentPage, currentSortBy);
        alert(bookId ? 'Book updated successfully!' : 'Book created successfully!');
      } catch (error) {
        showError('Error saving book: ' + error.message);
      }
    }

    // Delete book
    async function deleteBook(id) {
      if (!confirm('Are you sure you want to delete this book?')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/books/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const errorMessage = await response.text();
          throw new Error(errorMessage || 'Failed to delete book');
        }

        loadBooks(currentPage, currentSortBy);
        alert('Book deleted successfully!');
      } catch (error) {
        alert('Error deleting book: ' + error.message);
        showError('Error deleting book: ' + error.message);
      }
    }

    // Add to cart (keeping original functionality)
    function addToCart(id, name, price) {
      if (!confirm('Are you sure you want to add this book to cart?')) {
        return;
      }
      
      // Create a form and submit it
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/books/add-to-cart';
      
      // Add CSRF token
      const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
      
      if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
      }
      
      const idInput = document.createElement('input');
      idInput.type = 'hidden';
      idInput.name = 'id';
      idInput.value = id;
      form.appendChild(idInput);
      
      const nameInput = document.createElement('input');
      nameInput.type = 'hidden';
      nameInput.name = 'name';
      nameInput.value = name;
      form.appendChild(nameInput);
      
      const priceInput = document.createElement('input');
      priceInput.type = 'hidden';
      priceInput.name = 'price';
      priceInput.value = price;
      form.appendChild(priceInput);
      
      document.body.appendChild(form);
      form.submit();
    }

    // Helper functions
    function showLoading(show) {
      document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorMessage').style.display = 'none';
    }

    // Allow Enter key to search
    document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchBooks();
      }
    });
  </script>
</body>

</html>